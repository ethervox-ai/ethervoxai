name: Build and Test

on:
  push:
    branches: [ main, develop, 'feature/**', 'hotfix/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  build-desktop:
    name: Build Desktop Platforms
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            cmake_preset: linux-release
            cmake_platform: LINUX
          - os: windows-latest
            platform: windows
            cmake_preset: windows-release
            cmake_platform: WINDOWS
          - os: macos-latest
            platform: macos
            cmake_preset: macos-release
            cmake_platform: MACOS

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'

    - name: Cache CMake build directory
      uses: actions/cache@v4
      with:
        path: |
          build
          ~/.cmake
        key: ${{ runner.os }}-cmake-${{ env.BUILD_TYPE }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
        restore-keys: |
          ${{ runner.os }}-cmake-${{ env.BUILD_TYPE }}-
          ${{ runner.os }}-cmake-

    - name: Install Linux dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libasound2-dev \
          libcurl4-openssl-dev \
          libssl-dev \
          pkg-config \
          ninja-build

    - name: Install Windows dependencies
      if: matrix.platform == 'windows'
      run: |
        choco install ninja
        # Windows SDK and MSVC are pre-installed on GitHub runners

    - name: Setup MSVC environment
      if: matrix.platform == 'windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install macOS dependencies
      if: matrix.platform == 'macos'
      run: |
        brew install ninja pkg-config


    - name: Configure CMake
      run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DTARGET_PLATFORM=${{ matrix.cmake_platform }}

    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }}

    - name: Run unit tests
      run: ctest --test-dir build --output-on-failure -C ${{ env.BUILD_TYPE }} || true

    - name: Package artifacts
      run: |
        cmake --build build --config ${{ env.BUILD_TYPE }} --target package
        mkdir -p artifacts
        cp build/EtherVoxAI-*.* artifacts/ || true

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ethervoxai-${{ matrix.platform }}-${{ github.sha }}
        path: artifacts/
        retention-days: 30

  smoke:
    name: Quick smoke (fast fail)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run quick Makefile build
      continue-on-error: true
      run: |
        set -e
        make configure TARGET_PLATFORM=linux 2>&1 | tee quick-configure.log || true
        make build 2>&1 | tee quick-build.log || true

    - name: Upload quick build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: smoke-logs-${{ github.sha }}
        path: |
          quick-configure.log
          quick-build.log
        retention-days: 7

  build-raspberry-pi:
    name: Build Raspberry Pi
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: ['pi-zero', 'pi-4']
        include:
          - target: 'pi-zero'
            cmake_preset: 'rpi-zero-release'
            arch: 'armhf'
          - target: 'pi-4'
            cmake_preset: 'rpi-4-release'
            arch: 'arm64'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'

    - name: Install cross-compilation toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-arm-linux-gnueabihf \
          g++-arm-linux-gnueabihf \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          ninja-build

    - name: Prepare Raspberry Pi sysroot
      run: |
        chmod +x scripts/setup-rpi-toolchain.sh
        ./scripts/setup-rpi-toolchain.sh

    - name: Configure for Raspberry Pi (Makefile)
      run: make configure-rpi

    - name: Build for Raspberry Pi (Makefile)
      run: make build-rpi

    - name: Package Raspberry Pi artifacts
      run: |
        mkdir -p artifacts-${{ matrix.target }}
        cp build-${{ matrix.target }}/src/ethervoxai artifacts-${{ matrix.target }}/ || true
        cp -r build-${{ matrix.target }}/dashboard/dist artifacts-${{ matrix.target }}/dashboard || true

    - name: Upload Raspberry Pi artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ethervoxai-${{ matrix.target }}-${{ github.sha }}
        path: artifacts-${{ matrix.target }}/
        retention-days: 30

  test-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: build-desktop
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libasound2-dev \
          libcurl4-openssl-dev \
          libssl-dev \
          pkg-config \
          ninja-build \
          lcov

    - name: Configure Makefile build with coverage
      run: |
        # Create a coverage CMake configuration via the Makefile's configure target
        TARGET_PLATFORM=LINUX cmake -B build-coverage -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON

    - name: Build with coverage (Makefile/CMake)
      run: cmake --build build-coverage

    - name: Run tests with coverage
      working-directory: build-coverage
      run: |
        ctest --output-on-failure
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' --ignore-errors unused --output-file coverage.info
        lcov --list coverage.info
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5.5.1
      with:
        token: ${{ env.CODECOV_TOKEN }}
        files: build-coverage/coverage.info
        fail_ci_if_error: true
        verbose: true    