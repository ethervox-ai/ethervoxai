name: Code Quality

on:
  push:
    branches: [ main, develop, 'feature/**', 'hotfix/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  c-quality:
    name: C Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-format \
          clang-tidy \
          cppcheck \
          iwyu \
          cmake \
          ninja-build \
          libasound2-dev

    - name: Check C formatting
      continue-on-error: true
      run: |
        echo "=== C Format Check ==="
        # Only check files that exist
        FILES=$(find src include sdk tests -name "*.c" -o -name "*.h" 2>/dev/null || true)
        if [ -z "$FILES" ]; then
          echo "No C source files found to format"
          exit 0
        fi
        echo "$FILES" | xargs clang-format --dry-run --Werror --style=file || echo "Formatting issues found (non-blocking)"

    - name: Run clang-tidy
      continue-on-error: true
      run: |
        echo "=== C Static Analysis ==="
        # Configure via Makefile/CMake to generate compile commands
        cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        
        # Run clang-tidy on source files
        FILES=$(find src -type f \( -name "*.c" -o -name "*.cpp" \) | head -20)
        if [ -z "$FILES" ]; then
          echo "No C/C++ sources found; skipping clang-tidy." >&2
          exit 0
        fi
        echo "Running clang-tidy on:" && echo "$FILES"
        echo "$FILES" | tr '\n' '\0' | xargs -0 clang-tidy \
          -p build \
          --checks='modernize-*,performance-*,bugprone-*' \
          --warnings-as-errors=false

    - name: Run cppcheck
      run: |
        echo "=== Cppcheck Static Analysis ==="
        cppcheck --enable=all --std=c11 --platform=unix64 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=unmatchedSuppression \
          --error-exitcode=1 \
          --xml --xml-version=2 \
          src/ include/ sdk/ tests/ 2> cppcheck-report.xml || true
        
        # Convert XML to readable format
        if [ -f cppcheck-report.xml ]; then
          echo "Cppcheck found issues:"
          cat cppcheck-report.xml
        fi

    - name: Include What You Use (IWYU)
      run: |
        echo "=== Include Analysis ==="
        # Run IWYU on a subset of files to check include hygiene
        find src -name "*.c" | head -10 | while read file; do
          echo "Checking includes in $file"
          iwyu_tool.py -p build "$file" || true
        done

    - name: Upload C analysis results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: c-analysis-${{ github.sha }}
        path: |
          cppcheck-report.xml
          build/compile_commands.json
        retention-days: 15

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      continue-on-error: true
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten

    # Note: SARIF upload removed as it requires additional configuration
    # To enable, add generateSarif parameter to Semgrep action above

    - name: Secret scanning with TruffleHog (PR)
      uses: trufflesecurity/trufflehog@main
      if: github.event_name == 'pull_request'
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha }}
        head: ${{ github.event.pull_request.head.sha }}
        extra_args: --debug --only-verified

    - name: Secret scanning with TruffleHog (Push)
      uses: trufflesecurity/trufflehog@main
      if: github.event_name == 'push' && github.event.before != '0000000000000000000000000000000000000000'
      with:
        path: ./
        base: ${{ github.event.before }}
        head: ${{ github.event.after }}
        extra_args: --debug --only-verified

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js for Dashboard
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: '9'

    - name: Audit NPM dependencies
      working-directory: dashboard
      run: |
        pnpm install --frozen-lockfile
        pnpm audit --audit-level high
        pnpm outdated || true

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Check for known vulnerabilities
      continue-on-error: true
      env:
        SAFETY_API_KEY: ${{ secrets.SAFETY_API_KEY }}
      run: |
        if [ -z "$SAFETY_API_KEY" ]; then
          echo "SAFETY_API_KEY secret is not configured; skipping Safety scan." >&2
          exit 0
        fi
        python3 -m pip install --upgrade pip
        python3 -m pip install "safety>=3.0.0"
        safety scan --key "$SAFETY_API_KEY" --full-report

    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      continue-on-error: true
      with:
        project: 'EtherVoxAI'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --enableExperimental
          --failOnCVSS 7

    - name: Upload dependency check results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-check-report-${{ github.sha }}
        path: reports/
        retention-days: 30

  documentation-check:
    name: Documentation Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check markdown files
      uses: DavidAnson/markdownlint-cli2-action@v16
      continue-on-error: true
      with:
        config: '.markdownlint-cli2.yaml'

    - name: Check broken links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      continue-on-error: true
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.markdown-link-check.json'

    - name: Setup Node.js for markdownlint (for report)
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Save markdownlint report
      if: always()
      run: |
        echo "=== Generate markdownlint JSON report ==="
        # Use npx so we don't require global installs on the runner
        npx -y markdownlint-cli2 --config .markdownlint-cli2.yaml --format json > markdownlint-report.json || true

    - name: Upload markdownlint report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: markdownlint-report-${{ github.sha }}
        path: markdownlint-report.json
        retention-days: 30

    - name: Spell check
      uses: crate-ci/typos@master
      with:
        files: '*.md docs/ dashboard/README.md'

    - name: Check README completeness
      continue-on-error: true
      run: |
        echo "=== README Completeness Check ==="
        required_sections=("Installation" "Usage" "Contributing" "License")
        
        for section in "${required_sections[@]}"; do
          if grep -qi "## $section\|# $section" README.md; then
            echo "✓ Found $section section"
          else
            echo "⚠ Missing $section section"
          fi
        done

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: '9'

    - name: Install dashboard dependencies
      working-directory: dashboard
      run: pnpm install --frozen-lockfile

    - name: Install license checker
      run: npm install -g license-checker

    - name: Check NPM licenses
      working-directory: dashboard
      continue-on-error: true
      run: |
        echo "=== NPM License Check ==="
        license-checker \
          --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;CC-BY-NC-SA-4.0" \
          --exclude "safety" \
          --omit=dev || echo "⚠️  License check found issues (non-blocking)"

    - name: Check for license headers
      continue-on-error: true
      run: |
        echo "=== Source File License Headers ==="
        missing_headers=0

        # Check C files
        find src include -name "*.c" -o -name "*.h" | while read file; do
          if ! head -10 "$file" | grep -q "Copyright\|License\|SPDX"; then
            echo "Missing license header: $file"
            ((missing_headers++))
          fi
        done

        # Check JavaScript files
        find dashboard/src -name "*.js" -o -name "*.vue" -o -name "*.ts" | while read file; do
          if ! head -10 "$file" | grep -q "Copyright\|License\|SPDX"; then
            echo "Missing license header: $file"
            ((missing_headers++))
          fi
        done

        if [ $missing_headers -gt 0 ]; then
          echo "Found $missing_headers files missing license headers"
          echo "This is informational only and does not fail the build"
        fi

  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install analysis tools
      run: |
        pip install radon lizard tokei
        sudo apt-get install -y cloc

    - name: Generate code metrics
      run: |
        echo "=== Code Metrics Report ===" > metrics-report.txt
        echo "Generated: $(date)" >> metrics-report.txt
        echo "" >> metrics-report.txt
        
        echo "## Lines of Code (cloc)" >> metrics-report.txt
        cloc src/ include/ dashboard/src/ --exclude-dir=node_modules >> metrics-report.txt
        echo "" >> metrics-report.txt
        
        echo "## Cyclomatic Complexity (radon)" >> metrics-report.txt
        find . -name "*.py" | head -5 | xargs radon cc -s || echo "No Python files found" >> metrics-report.txt
        echo "" >> metrics-report.txt
        
        echo "## Code Complexity (lizard)" >> metrics-report.txt
        lizard src/ -l cpp --sort cyclomatic_complexity | head -20 >> metrics-report.txt
        echo "" >> metrics-report.txt
        
        echo "## File Statistics" >> metrics-report.txt
        echo "Total files: $(find . -type f | wc -l)" >> metrics-report.txt
        echo "C files: $(find . -name "*.c" -o -name "*.h" | wc -l)" >> metrics-report.txt
        echo "JavaScript/Vue files: $(find . -name "*.js" -o -name "*.vue" -o -name "*.ts" | wc -l)" >> metrics-report.txt

    - name: Upload metrics report
      uses: actions/upload-artifact@v4
      with:
        name: code-metrics-${{ github.sha }}
        path: metrics-report.txt
        retention-days: 30