name: Build ESP32 Firmware

on:
  push:
    branches: [ main, develop, 'feature/**', 'hotfix/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      target:
        description: 'ESP32 target board'
        required: true
        default: 'esp32'
        type: choice
        options:
          - esp32
          - esp32s2
          - esp32s3
          - esp32c3
          - esp32c6

env:
  IDF_VERSION: 'v5.1.2'

jobs:
  build-esp32:
    name: Build ESP32 Firmware
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: ['esp32', 'esp32s2', 'esp32s3', 'esp32c3', 'esp32c6']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install ESP-IDF dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv \
          cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

    - name: Setup ESP-IDF
      run: |
        mkdir -p ~/esp
        cd ~/esp
        if [ ! -d "esp-idf" ]; then
          git clone --recursive --branch ${{ env.IDF_VERSION }} --depth 1 https://github.com/espressif/esp-idf.git
        fi
        cd esp-idf
        ./install.sh ${{ matrix.target }}
        
    - name: Cache ESP-IDF tools
      uses: actions/cache@v4
      with:
        path: |
          ~/.espressif
          ~/esp/esp-idf
        key: ${{ runner.os }}-esp-idf-${{ env.IDF_VERSION }}-${{ matrix.target }}-v2
        restore-keys: |
          ${{ runner.os }}-esp-idf-${{ env.IDF_VERSION }}-
          ${{ runner.os }}-esp-idf-

    - name: Build ESP32 firmware
      shell: bash
      run: |
        # Source ESP-IDF environment
        . ~/esp/esp-idf/export.sh
        
        # Navigate to project and configure
        cd esp32-project
        idf.py set-target ${{ matrix.target }}
        idf.py build

    - name: Generate build info
      shell: bash
      run: |
        cd esp32-project
        echo "ESP32_TARGET=${{ matrix.target }}" >> build_info.txt
        echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> build_info.txt
        echo "COMMIT_SHA=${{ github.sha }}" >> build_info.txt
        echo "IDF_VERSION=${{ env.IDF_VERSION }}" >> build_info.txt

    - name: Package ESP32 artifacts
      shell: bash
      run: |
        # Create artifacts directory in workspace root
        ARTIFACTS_DIR="${GITHUB_WORKSPACE}/esp32-artifacts-${{ matrix.target }}"
        mkdir -p "${ARTIFACTS_DIR}"
        
        # Copy firmware binaries
        cp esp32-project/build/ethervoxai.bin "${ARTIFACTS_DIR}/"
        cp esp32-project/build/ethervoxai.elf "${ARTIFACTS_DIR}/"
        cp esp32-project/build/bootloader/bootloader.bin "${ARTIFACTS_DIR}/"
        cp esp32-project/build/partition_table/partition-table.bin "${ARTIFACTS_DIR}/"
        
        # Copy partition table and other config files
        cp esp32-project/partitions.csv "${ARTIFACTS_DIR}/" || echo "partitions.csv not found, skipping"
        cp esp32-project/sdkconfig "${ARTIFACTS_DIR}/"
        cp esp32-project/build_info.txt "${ARTIFACTS_DIR}/"
        
        # Generate flash instructions
        {
          echo "# ESP32 Flash Instructions"
          echo ""
          echo "Target: ${{ matrix.target }}"
          echo "Built: $(date)"
          echo ""
          echo "## Flash Command:"
          echo '```bash'
          echo "esptool.py --chip ${{ matrix.target }} --port /dev/ttyUSB0 --baud 460800 write_flash -z \\"
          echo "  --flash_mode dio --flash_freq 40m --flash_size detect \\"
          echo "  0x1000 bootloader.bin \\"
          echo "  0x8000 partition-table.bin \\"
          echo "  0x10000 ethervoxai.bin"
          echo '```'
        } > "${ARTIFACTS_DIR}/FLASH.md"


    - name: Upload ESP32 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ethervoxai-esp32-${{ matrix.target }}-${{ github.sha }}
        path: esp32-artifacts-${{ matrix.target }}/
        retention-days: 30

    - name: Check firmware size
      shell: bash
      run: |
        cd esp32-project/build
        echo "=== Firmware Size Analysis ==="
        echo "Target: ${{ matrix.target }}"
        echo "Firmware size: $(stat -c%s ethervoxai.bin) bytes"
        echo "Bootloader size: $(stat -c%s bootloader/bootloader.bin) bytes"
        echo "Partition table size: $(stat -c%s partition_table/partition-table.bin) bytes"
        
        # Show memory usage
        if [ -f ethervoxai.map ]; then
          echo "=== Memory Usage ==="
          grep -A 20 "Memory Configuration" ethervoxai.map || echo "Memory info not available"
        fi

  validate-esp32-config:
    name: Validate ESP32 Configuration
    runs-on: ubuntu-latest
    needs: build-esp32

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: ${{ env.IDF_VERSION }}
        target: esp32

    - name: Validate sdkconfig
      shell: bash
      run: |
        . ~/esp/esp-idf/export.sh
        cd esp32-project
        echo "=== Validating ESP32 Configuration ==="
        
        # Check for required configs
        if ! grep -q "CONFIG_ETHERVOXAI_ENABLE=y" sdkconfig.defaults; then
          echo "Warning: EtherVoxAI not enabled in default config"
        fi
        
        # Validate memory settings
        if grep -q "CONFIG_SPIRAM_SUPPORT=y" sdkconfig.defaults; then
          echo "✓ PSRAM support enabled"
        else
          echo "Warning: PSRAM support not enabled - may limit functionality"
        fi
        
        # Check WiFi settings
        if grep -q "CONFIG_ESP32_WIFI_SW_COEXIST_ENABLE=y" sdkconfig.defaults; then
          echo "✓ WiFi coexistence enabled"
        fi
        
        echo "Configuration validation complete"

  security-check-esp32:
    name: ESP32 Security Check
    runs-on: ubuntu-latest
    needs: build-esp32

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: ${{ env.IDF_VERSION }}
        target: esp32

    - name: Security configuration check
      shell: bash
      run: |
        cd esp32-project
        echo "=== ESP32 Security Check ==="
        
        # Check for secure boot configuration
        if grep -q "CONFIG_SECURE_BOOT=y" sdkconfig.defaults; then
          echo "✓ Secure boot enabled"
        else
          echo "Info: Secure boot not enabled (recommended for production)"
        fi
        
        # Check for flash encryption
        if grep -q "CONFIG_SECURE_FLASH_ENC_ENABLED=y" sdkconfig.defaults; then
          echo "✓ Flash encryption enabled"
        else
          echo "Info: Flash encryption not enabled (recommended for production)"
        fi
        
        # Check for debug settings in production
        if grep -q "CONFIG_LOG_DEFAULT_LEVEL_DEBUG=y" sdkconfig.defaults; then
          echo "Warning: Debug logging enabled - not recommended for production"
        fi
        
        echo "Security check complete"